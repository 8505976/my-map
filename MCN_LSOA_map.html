<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Interactive PCs & MCN LSOAs â€” Unified Metadata Box (Refactored)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    #metadata {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(255,255,255,0.9); border: 1px solid #333;
      padding: 15px 20px; border-radius: 4px;
      font-size: clamp(20px, 3vw, 25px); box-shadow: 0 0 6px rgba(0,0,0,0.3);
      z-index: 1000; pointer-events: auto;
      max-height: 30vw; max-width: 80vw;
      overflow-x: auto; white-space: normal;
    }
    #metadata table { border-collapse: collapse; margin-top: 6px; width: 100%; }
    #metadata th, #metadata td {
      padding: 2px 8px; border: 1px solid #666; text-align: center;
    }
    #metadata th { background: #eee; }
    .leaflet-tooltip-custom {
      background: rgba(255,255,255,0.95); border: 1px solid #333;
      padding: 8px 16px; font-size: clamp(16px, 2vw, 24px);
      border-radius: 4px; pointer-events: none;
    }

    /* Legend control */
    .leaflet-control-legend {
      background: white;
      padding: 6px 8px;
      font: 14px Arial, Helvetica, sans-serif;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      line-height: 1.4;
    }
    .leaflet-control-legend .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .leaflet-control-legend .legend-item:last-child {
      margin-bottom: 0;
    }
    .leaflet-control-legend .legend-swatch {
      width: 18px;
      height: 18px;
      margin-right: 8px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="metadata"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Globals & constants
    let map, pcLayer, highlightLayer, mcnLayer, lsoaHighlightLayer, mcnData;
    let selectedConstituencyName = '';
    let lsoaSelected = false;
    const metadataDiv = document.getElementById('metadata');
    const baseColors = { 1: '#103a5e', 0: '#DADDD8' };
    const highlightColors = { 1: '#009a9e', 0: '#EAECE9' };

    // Utility functions
    function formatScore(value) {
      const n = parseFloat(value);
      return isNaN(n) ? '' : n.toFixed(2);
    }

    function updateMetadataTable(props) {
      metadataDiv.innerHTML = '';
      const header = document.createElement('div');
      header.innerHTML = `<strong>${selectedConstituencyName}</strong><br><em>${props["LSOA (2021) name"]}</em>`;
      metadataDiv.appendChild(header);

      const metadataMap = [
        ["Hyper local need measure",              "Hyper-local need measure score (where higher score = higher need)",             "Hyper-local need measure Rank (where 1 = highest need)"],
        ["Kickstart economic growth",             "Kickstart economic growth Score (where higher score = higher need)",           "Kickstart economic growth Rank (where 1 = highest need)"],
        ["Make Britain a clean energy superpower","Make Britain a clean energy superpower Score (where higher score = higher need)","Make Britain a clean energy superpower Rank (where 1 = highest need)"],
        ["Take back our streets",                 "Take back our streets Score (where higher score = higher need)",               "Take back our streets Rank (where 1 = highest need)"],
        ["Break down barriers to opportunity",    "Break down barriers to opportunity Score (where higher score = higher need)",  "Break down barriers to opportunity Rank (where 1 = highest need)"],
        ["Build an NHS fit for the future",       "Build an NHS fit for the future Score (where higher score = higher need)",     "Build an NHS fit for the future Rank (where 1 = highest need)"]
      ];

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th></th><th>Score</th><th>Rank</th></tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      metadataMap.forEach(([label, scoreKey, rankKey]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <th>${label}</th>
          <td>${formatScore(props[scoreKey])}</td>
          <td>${props[rankKey] ?? ''}</td>
        `;
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      metadataDiv.appendChild(table);
    }

    function clearMCNLayer() {
      mcnLayer.eachLayer(layer => {
        layer.off();
        if (layer.unbindTooltip) layer.unbindTooltip();
      });
      mcnLayer.clearLayers();
    }

    function clearAllTooltips() {
      map.eachLayer(layer => {
        if (layer instanceof L.Tooltip) {
          map.removeLayer(layer);
        }
      });
    }

    function clearAllSelections(resetView = false) {
      clearAllTooltips();
      highlightLayer.clearLayers();
      lsoaHighlightLayer.clearLayers();
      clearMCNLayer();
      metadataDiv.innerHTML = '';
      selectedConstituencyName = '';
      lsoaSelected = false;
      if (resetView) {
        map.flyTo([53.5, -1.5], 7, { duration: 0.25 });
      }
    }

    // Feature handlers
    function onPCClick(feature, layer) {
      const code = feature.properties.PCON24CD;
      const matches = mcnData.features.filter(d => d.properties.PCON25CD === code);

      clearAllSelections();
      selectedConstituencyName = feature.properties.PCON24NM;
      metadataDiv.innerHTML = `<strong>${selectedConstituencyName}</strong>`;
      highlightLayer.addData(feature);

      if (matches.length) {
        mcnLayer.addData({
          type: 'FeatureCollection',
          features: matches
        });
        mcnLayer.bringToFront();
      }

      map.fitBounds(layer.getBounds(), {
        padding: [30, 30],
        animate: true,
        duration: 0.75
      });
    }

    function attachPCHandlers(feature, layer) {
      layer.defaultStyle = {
        color: 'white', weight: 1, fillOpacity: 1,
        fillColor: baseColors[feature.properties.has_mcn]
      };
      layer.setStyle(layer.defaultStyle);

      const tooltip = L.tooltip({ direction: 'top', className: 'leaflet-tooltip-custom' })
                       .setContent(feature.properties.PCON24NM);

      layer.on('mouseover', e => {
        tooltip.setLatLng(e.latlng).addTo(map);
        layer.setStyle({
          weight: 1, color: 'white',
          fillColor: highlightColors[feature.properties.has_mcn]
        });
      });
      layer.on('mousemove', e => tooltip.setLatLng(e.latlng));
      layer.on('mouseout', () => {
        map.removeLayer(tooltip);
        layer.setStyle(layer.defaultStyle);
      });
      layer.on('click', () => onPCClick(feature, layer));
    }

    function onMCNClick(feature, layer) {
      lsoaHighlightLayer.clearLayers();
      lsoaHighlightLayer.addData(feature);
      lsoaSelected = true;
      updateMetadataTable(feature.properties);
    }

    function attachMCNHandlers(feature, layer) {
      layer.defaultStyle = {
        color: 'black',    // <-- always black boundary
        weight: 2, 
        fillColor: '#FF4A47',
        fillOpacity: 1
      };
      layer.setStyle(layer.defaultStyle);

      const tooltip = L.tooltip({ direction: 'top', className: 'leaflet-tooltip-custom' })
                       .setContent(feature.properties["LSOA (2021) name"]);

      layer.on('mouseover', e => {
        tooltip.setLatLng(e.latlng).addTo(map);
        layer.setStyle({
          weight: 2, 
          color: 'black',       // <-- keep boundary black on hover
          fillColor: '#FF9B99'
        });
      });
      layer.on('mousemove', e => tooltip.setLatLng(e.latlng));
      layer.on('mouseout', () => {
        map.removeLayer(tooltip);
        layer.setStyle(layer.defaultStyle);
      });
      layer.on('click', () => onMCNClick(feature, layer));
    }

    // Legend control
    const LegendControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function(map) {
        const div = L.DomUtil.create('div','leaflet-control-legend');
        div.innerHTML = `
          <div class="legend-item">
            <span class="legend-swatch" style="background:${baseColors[1]}"></span>
            <span>Has MCN</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch" style="background:${baseColors[0]}"></span>
            <span>No MCN</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch" style="background:#FF4A47"></span>
            <span>MCN</span>
          </div>
        `;
        return div;
      }
    });

    // Initialization
    function setupKeyHandler() {
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          if (lsoaSelected) {
            lsoaHighlightLayer.clearLayers();
            metadataDiv.innerHTML = `<strong>${selectedConstituencyName}</strong>`;
            lsoaSelected = false;
          } else if (selectedConstituencyName) {
            clearAllSelections(true);
          }
        }
      });
    }

    function createMap() {
      map = L.map('map', {
        maxBounds: [[47, -20], [60, 12]],
        maxBoundsViscosity: 1.0,
        minZoom: 7,
        maxZoom: 18
      }).setView([53.5, -1.5], 7);

      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
        { subdomains: 'abcd', attribution: '&copy; OSM &copy; CARTO' }
      ).addTo(map);
      map.attributionControl.setPrefix(
        '<a href="https://leafletjs.com" title="Leaflet map library">Leaflet</a>'
      );

      highlightLayer = L.geoJSON(null, {
        style: f => ({
          color: 'white', weight: 1, fillOpacity: 1,
          fillColor: highlightColors[f.properties.has_mcn]
        })
      }).addTo(map);

      lsoaHighlightLayer = L.geoJSON(null, {
        style: { 
          color: 'black',      // <-- always black boundary 
          weight: 2, 
          fillColor: '#FF9B99', 
          fillOpacity: 1 
        }
      }).addTo(map);

      mcnLayer = L.geoJSON(null, {
        onEachFeature: attachMCNHandlers
      }).addTo(map);

      pcLayer = L.geoJSON(null, {
        onEachFeature: attachPCHandlers
      }).addTo(map);

      // add legend
      map.addControl(new LegendControl());
    }

    async function loadData() {
      try {
        const [pcResp, mcnResp] = await Promise.all([
          fetch('PCs_Eng_2025.geojson'),
          fetch('MCN_LSOAs.geojson')
        ]);
        if (!pcResp.ok) throw new Error(`PCs load failed: ${pcResp.status}`);
        if (!mcnResp.ok) throw new Error(`MCN_LSOAs load failed: ${mcnResp.status}`);

        const [pcGeo, mcnGeo] = await Promise.all([pcResp.json(), mcnResp.json()]);
        mcnData = mcnGeo;
        pcLayer.addData(pcGeo);
      } catch (err) {
        metadataDiv.innerHTML = `<strong>Error loading data</strong><br>${err.message}`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      createMap();
      setupKeyHandler();
      loadData();
    });
  </script>
</body>
</html>
