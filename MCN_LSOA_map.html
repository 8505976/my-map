<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive PCs & MCN LSOAs — Unified Metadata Box</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    /* 1. Global font stack */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family:
        -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    /* 2. Map container */
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }

    /* close button inside metadata */
    #metadata .metadata-close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 1.2em;
      line-height: 1;
      cursor: pointer;
      color: #103a5e;
    }

    /* 3. Metadata box (bottom‑left) */
    #metadata {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #333;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      z-index: 1000;
      pointer-events: auto;
      max-height: 35vh;
      max-width: 75vw;
      width: auto;
      overflow-x: auto;
      white-space: normal;
      color: #103a5e;
      font-size: clamp(14px, min(1.25vw, 2.25vh), 25px);
    }
    #metadata table {
      border-collapse: collapse;
      margin-top: 6px;
      width: auto;
      max-width: 100%;
    }
    #metadata th, #metadata td {
      padding: 2px 8px;
      border: 1px solid #666;
      text-align: center;
      color: #103a5e;
    }
    #metadata th { background: #eee; }

    /* 4. Custom tooltips */
    .leaflet-tooltip-custom {
      background: rgba(255,255,255,0.95);
      border: 1px solid #333;
      padding: 8px 16px;
      font-size: clamp(14px, 2vh, 24px);
      color: #103a5e;
      border-radius: 4px;
      pointer-events: none;
    }

    /* 5. Legend control */
    .leaflet-control-legend {
      background: white;
      padding: 6px 8px;
      font-size: clamp(14px, 1.5vw, 18px);
      color: #103a5e;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      line-height: 1.4;
    }
    .leaflet-control-legend .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .leaflet-control-legend .legend-item:last-child {
      margin-bottom: 0;
    }
    .leaflet-control-legend .legend-swatch {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    @media (max-width: 600px) {
      #metadata {
        bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="metadata"><em>Select a constituency with MCNs</em></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Globals
    let map, pcLayer, highlightLayer, mcnLayer, lsoaHighlightLayer, mcnData;
    let selectedConstituencyName = '';
    let lsoaSelected = false;
    const metadataDiv = document.getElementById('metadata');
    const baseColors = { 1: '#103a5e', 0: '#DADDD8' };
    const highlightColors = { 1: '#009a9e', 0: '#EAECE9' };
	const isTouchDevice = window.matchMedia('(hover: none)').matches;


    // Format helper
    function formatScore(v) {
      const n = parseFloat(v);
      return isNaN(n) ? '' : n.toFixed(2);
    }

    // RENDER PC‐LEVEL METADATA (with close btn)
    function renderPCMetadata() {
      metadataDiv.innerHTML = '';
      // close button
      const btn = document.createElement('button');
      btn.className = 'metadata-close-btn';
      btn.innerHTML = '&times;';
      btn.onclick = () => clearAllSelections(true);
      metadataDiv.appendChild(btn);
      // header
      const header = document.createElement('div');
      header.innerHTML =
        `<strong>${selectedConstituencyName}</strong><br>` +
        `<em>Select an MCN for more details</em>`;
      metadataDiv.appendChild(header);
    }

    // RENDER LSOA TABLE (with its own close btn)
    function updateMetadataTable(props) {
      metadataDiv.innerHTML = '';
      const btn = document.createElement('button');
      btn.className = 'metadata-close-btn';
      btn.innerHTML = '&times;';
      btn.onclick = () => {
        lsoaHighlightLayer.clearLayers();
        lsoaSelected = false;
        renderPCMetadata();
      };
      metadataDiv.appendChild(btn);

      const header = document.createElement('div');
      header.innerHTML =
        `<strong>${selectedConstituencyName}</strong><br>` +
        `${props["LSOA (2021) name"]}`;
      metadataDiv.appendChild(header);

      const rows = [
        ["Hyper local need measure",  "Hyper-local need measure score (where higher score = higher need)",  "Hyper-local need measure Rank (where 1 = highest need)"],
        ["Kickstart economic growth", "Kickstart economic growth Score (where higher score = higher need)",    "Kickstart economic growth Rank (where 1 = highest need)"],
        ["Make Britain a clean energy superpower", "Make Britain a clean energy superpower Score (where higher score = higher need)", "Make Britain a clean energy superpower Rank (where 1 = highest need)"],
        ["Take back our streets",      "Take back our streets Score (where higher score = higher need)",      "Take back our streets Rank (where 1 = highest need)"],
        ["Break down barriers to opportunity", "Break down barriers to opportunity Score (where higher score = higher need)", "Break down barriers to opportunity Rank (where 1 = highest need)"],
        ["Build an NHS fit for the future", "Build an NHS fit for the future Score (where higher score = higher need)",   "Build an NHS fit for the future Rank (where 1 = highest need)"]
      ];

      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th></th><th>Score</th><th>Rank</th></tr></thead>`;
      const tb = document.createElement('tbody');
      rows.forEach(([label, scoreKey, rankKey]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <th>${label}</th>
          <td>${formatScore(props[scoreKey])}</td>
          <td>${props[rankKey] ?? ''}</td>
        `;
        tb.appendChild(tr);
      });
      table.appendChild(tb);
      metadataDiv.appendChild(table);
    }

    // CLEAR helpers
    function clearMCNLayer() {
      mcnLayer.eachLayer(l => {
        l.off();
        l.unbindTooltip && l.unbindTooltip();
      });
      mcnLayer.clearLayers();
    }
    function clearAllTooltips() {
      map.eachLayer(l => l instanceof L.Tooltip && map.removeLayer(l));
    }
    function clearAllSelections(reset = false) {
      clearAllTooltips();
      highlightLayer.clearLayers();
      lsoaHighlightLayer.clearLayers();
      clearMCNLayer();
      selectedConstituencyName = '';
      lsoaSelected = false;
	  if (reset && map.getZoom() > 9) {
		map.setZoom(9);
	  }
      metadataDiv.innerHTML = '<em>Select a constituency with MCNs</em>';
    }

    // PC click
	function onPCClick(feature, layer) {
	  clearAllSelections();

	  selectedConstituencyName = feature.properties.PCON24NM;

	  // Highlight selected constituency no matter what
	  highlightLayer.addData(feature);

	  if (feature.properties.has_mcn) {
		// This is an MCN-having constituency
		renderPCMetadata();

		const code = feature.properties.PCON24CD;
		const matches = mcnData.features.filter(d => d.properties.PCON25CD === code);

		if (matches.length) {
		  mcnLayer.addData({ type: 'FeatureCollection', features: matches });
		  mcnLayer.bringToFront();
		}

		map.fitBounds(layer.getBounds(), { padding: [30, 30], animate: true, duration: 0.75 });
	  } else {
		// This is a non-MCN constituency — show a message
		metadataDiv.innerHTML = '';

		const closeBtn = document.createElement('button');
		closeBtn.className = 'metadata-close-btn';
		closeBtn.innerHTML = '&times;';
		closeBtn.addEventListener('click', () => {
		  clearAllSelections(true);
		});
		metadataDiv.appendChild(closeBtn);

		const header = document.createElement('div');
		header.innerHTML =
		  `<strong>${selectedConstituencyName}</strong><br>` +
		  `<em>Select a constituency with MCNs</em>`;
		metadataDiv.appendChild(header);
	  }
	}

    // MCN click
    function onMCNClick(f) {
      lsoaHighlightLayer.clearLayers();
      lsoaHighlightLayer.addData(f);
      lsoaSelected = true;
      updateMetadataTable(f.properties);
    }

    // Handlers attachers
	function attachPCHandlers(f, layer) {
	  layer.defaultStyle = {
		color: 'white', weight: 1, fillOpacity: 1,
		fillColor: baseColors[f.properties.has_mcn]
	  };
	  layer.setStyle(layer.defaultStyle);

	  let tooltip;
	  if (!isTouchDevice) {
		tooltip = L.tooltip({ direction: 'top', className: 'leaflet-tooltip-custom' })
					 .setContent(f.properties.PCON24NM);

		layer.on('mouseover', e => {
		  tooltip.setLatLng(e.latlng).addTo(map);
		  layer.setStyle({ ...layer.defaultStyle, fillColor: highlightColors[f.properties.has_mcn] });
		});
		layer.on('mousemove', e => tooltip.setLatLng(e.latlng));
		layer.on('mouseout', () => {
		  map.removeLayer(tooltip);
		  layer.setStyle(layer.defaultStyle);
		});
	  }

	  // This should always be registered, regardless of touch support
	  layer.on('click', () => onPCClick(f, layer));
	}

	function attachMCNHandlers(f, layer) {
	  layer.defaultStyle = {
		color: 'black', weight: 1,
		fillColor: '#FF4A47', fillOpacity: 1
	  };
	  layer.setStyle(layer.defaultStyle);

	  let tooltip;
	  if (!isTouchDevice) {
		tooltip = L.tooltip({ direction: 'top', className: 'leaflet-tooltip-custom' })
					 .setContent(f.properties["LSOA (2021) name"]);

		layer.on('mouseover', e => {
		  tooltip.setLatLng(e.latlng).addTo(map);
		  layer.setStyle({ ...layer.defaultStyle, fillColor: '#FF9B99' });
		});
		layer.on('mousemove', e => tooltip.setLatLng(e.latlng));
		layer.on('mouseout', () => {
		  map.removeLayer(tooltip);
		  layer.setStyle(layer.defaultStyle);
		});
	  }

	  // Always allow click selection
	  layer.on('click', () => onMCNClick(f, layer));
	}

    // Legend
    const LegendControl = L.Control.extend({
      options:{ position:'topright' },
      onAdd: () => {
        const div = L.DomUtil.create('div','leaflet-control-legend');
        div.innerHTML = `
          <div class="legend-item">
            <span class="legend-swatch" style="background:${baseColors[1]}"></span>
            <span>Constituency with MCNs</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch" style="background:${baseColors[0]}"></span>
            <span>Constituency without MCNs</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch" style="background:#FF4A47"></span>
            <span>MCN</span>
          </div>`;
        return div;
      }
    });

    // Escape key handler
    function setupKeyHandler() {
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          if (lsoaSelected) {
            lsoaHighlightLayer.clearLayers();
            lsoaSelected = false;
            renderPCMetadata();
          } else if (selectedConstituencyName) {
            clearAllSelections(true);
          }
        }
      });
    }

    // Map init
    function createMap() {
      map = L.map('map',{ maxBounds:[[47,-20],[60,12]], maxBoundsViscosity:1.0, minZoom:7, maxZoom:18 })
        .setView([53.5,-1.5],7);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{
        subdomains:'abcd', attribution:'&copy; OSM &copy; CARTO'
      }).addTo(map);
      map.attributionControl.setPrefix('<a href="https://leafletjs.com">Leaflet</a>');

      highlightLayer    = L.geoJSON(null,{ style:f=>({ color:'white', weight:1, fillOpacity:1, fillColor:highlightColors[f.properties.has_mcn] }) }).addTo(map);
      lsoaHighlightLayer= L.geoJSON(null,{ style:{ color:'black', weight:1, fillColor:'#FF9B99', fillOpacity:1 } }).addTo(map);
      mcnLayer          = L.geoJSON(null,{ onEachFeature:attachMCNHandlers }).addTo(map);
      pcLayer           = L.geoJSON(null,{ onEachFeature:attachPCHandlers }).addTo(map);

      map.addControl(new LegendControl());
    }

    // Data load
    async function loadData(){
      try {
        const [pcR,mR] = await Promise.all([
          fetch('PCs_Eng_2025.geojson'),
          fetch('MCN_LSOAs.geojson')
        ]);
        if(!pcR.ok) throw new Error(`PCs load failed: ${pcR.status}`);
        if(!mR.ok)  throw new Error(`MCN_LSOAs load failed: ${mR.status}`);
        const [pcGeo, mGeo] = await Promise.all([pcR.json(), mR.json()]);
        mcnData = mGeo;
        pcLayer.addData(pcGeo);
      } catch(err) {
        metadataDiv.innerHTML = `<strong>Error loading data</strong><br>${err.message}`;
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      createMap();
      setupKeyHandler();
      loadData();
    });
  </script>
</body>
</html>
